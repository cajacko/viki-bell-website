FROM node:latest

EXPOSE 5000

RUN mkdir /var/www && mkdir /var/www/web
WORKDIR /var/www/web

RUN npm install pm2 -g

RUN apt-get install -y autoconf
RUN apt-get install -y automake
RUN apt-get install -y git
RUN git clone https://github.com/facebook/watchman.git
WORKDIR /var/www/web/watchman
RUN git checkout v4.7.0
RUN ./autogen.sh
RUN ./configure --without-python
RUN make
RUN make install

WORKDIR /var/www/web

COPY web/package.json /var/www/web/package.json
RUN npm install

COPY .env /var/www/.env
COPY .env-sample /var/www/.env-sample
COPY web /var/www/web
RUN npm run build:production

CMD ["pm2-docker", "/var/www/web/dist/server/index.js"]
